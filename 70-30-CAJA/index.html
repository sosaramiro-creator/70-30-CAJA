<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Par√°metros de Caja y Fijos Mensuales</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background: #f4f4f4;
      color: #222;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 20px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .btn {
      padding: 6px 10px;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      background: #222;
      color: #fff;
      font-size: 12px;
    }
    .btn.secondary {
      background: #777;
    }
    .btn.danger {
      background: #b21f2d;
    }
    .layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .card {
      background: #fff;
      border-radius: 6px;
      padding: 10px;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
    }
    .card-title {
      font-weight: bold;
      margin-bottom: 6px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 4px;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 4px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
      font-weight: bold;
    }
    input[type="number"], input[type="text"] {
      width: 100%;
      padding: 2px 4px;
      font-size: 12px;
    }
    .summary-row {
      font-weight: bold;
      background: #fafafa;
    }
    .right {
      text-align: right;
    }
    .flex-row {
      display: flex;
      gap: 6px;
      align-items: center;
      margin: 4px 0;
    }
    .flex-row label {
      flex: 1 0 60%;
      font-size: 12px;
    }
    .flex-row input {
      flex: 1 0 40%;
    }
    #historial-table {
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid #ddd;
    }
    .note {
      font-size: 10px;
      color: #777;
      margin-top: 4px;
    }
    .alert-ok {
      color: green;
      font-weight: bold;
    }
    .alert-bad {
      color: red;
      font-weight: bold;
    }

    @media print {
      body {
        background: #fff;
        padding: 0;
      }
      .top-bar {
        display: none;
      }
      .card {
        box-shadow: none;
        border: 1px solid #ccc;
        page-break-inside: avoid;
      }
      #historial-table {
        max-height: none;
        overflow: visible;
      }
    }
  </style>
</head>
<body>
  <h1>Par√°metros de Caja y Fijos Mensuales</h1>

  <div class="top-bar">
    <div>
      <button class="btn" onclick="exportarJSON()">üíæ Backup JSON</button>
      <label class="btn secondary">
        üìÇ Importar JSON
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importarJSON(event)">
      </label>
    </div>
    <div>
      <button class="btn secondary" onclick="agregarAlHistorial()">‚ûï Guardar d√≠a en historial</button>
      <button class="btn" onclick="window.print()">üñ®Ô∏è Imprimir</button>
    </div>
  </div>

  <div class="layout">
    <!-- PAR√ÅMETROS Y FIJOS -->
    <div class="card">
      <div class="card-title">Par√°metros de Caja</div>

      <div class="flex-row">
        <label>Porcentaje Caja Operativa (%)</label>
        <input type="number" id="pctCajaOperativa" value="70" step="0.01" oninput="recalcularTodo()">
      </div>
      <div class="flex-row">
        <label>Porcentaje Saldo Neto (%)</label>
        <input type="number" id="pctSaldoNeto" value="30" step="0.01" oninput="recalcularTodo()">
      </div>

      <hr>

      <div class="flex-row">
        <label>Porcentaje Neto ‚Üí Deuda flotante (%)</label>
        <input type="number" id="pctNetoDeuda" value="70" step="0.01" oninput="recalcularTodo()">
      </div>
      <div class="flex-row">
        <label>Porcentaje Neto ‚Üí Reserva emergencia (%)</label>
        <input type="number" id="pctNetoReserva" value="20" step="0.01" oninput="recalcularTodo()">
      </div>
      <div class="flex-row">
        <label>Retribuci√≥n diaria del due√±o ($ fijo)</label>
        <input type="number" id="retribucionDuenio" value="0" step="100" oninput="recalcularTodo()">
      </div>

      <div class="flex-row">
        <label>D√≠as del mes para prorrateo</label>
        <input type="number" id="diasProrrateo" value="30" step="1" oninput="recalcularTodo()">
      </div>

      <hr>
      <div class="card-title">Fijos mensuales por √≠tem</div>

      <table id="tablaFijos">
        <thead>
          <tr>
            <th style="width:55%">√çtem</th>
            <th style="width:35%">Monto mensual ($)</th>
            <th style="width:10%">Acci√≥n</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filas din√°micas -->
        </tbody>
        <tfoot>
          <tr class="summary-row">
            <td>Total fijos mensuales</td>
            <td class="right" id="totalFijos">$0,00</td>
            <td></td>
          </tr>
          <tr class="summary-row">
            <td>Fijo prorrateado diario (Total / D√≠as)</td>
            <td class="right" id="fijoDiario">$0,00</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
      <button class="btn secondary" style="margin-top:6px" onclick="agregarFilaFijo()">‚ûï Agregar √≠tem</button>

      <div class="note">Edit√°s directamente los √≠tems y montos. El total y el prorrateo se recalculan solos.</div>
    </div>

    <!-- MODELO 70/30 + SUBDISTRIBUCI√ìN NETO -->
    <div class="card">
      <div class="card-title">Modelo 70/30 con reserva previa y subdistribuci√≥n del Neto</div>

      <!-- Ingreso diario y 70/30 -->
      <div class="flex-row">
        <label>Ingreso diario de caja ($)</label>
        <input type="number" id="ingresoDiario" value="0" step="100" oninput="recalcularTodo()">
      </div>

      <table>
        <tbody>
          <tr>
            <td>Fijo prorrateado diario (desde Par√°metros)</td>
            <td class="right" id="fijoDiario7030">$0,00</td>
          </tr>
          <tr>
            <td>Resto disponible (Ingreso - Fijo diario)</td>
            <td class="right" id="restoDisponible">$0,00</td>
          </tr>
          <tr>
            <td>Operativo (seg√∫n % Caja Operativa)</td>
            <td class="right" id="montoOperativo">$0,00</td>
          </tr>
          <tr>
            <td>NETO REAL (seg√∫n % Saldo Neto)</td>
            <td class="right" id="montoNetoReal">$0,00</td>
          </tr>
        </tbody>
      </table>

      <br>

      <!-- Uso del Operativo -->
      <table>
        <thead>
          <tr>
            <th colspan="2">Uso del Operativo</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Operativo variable</td>
            <td><input type="number" id="opVariable" value="0" step="100" oninput="recalcularTodo()"></td>
          </tr>
          <tr>
            <td>Pagos / Proveedores</td>
            <td><input type="number" id="opPagos" value="0" step="100" oninput="recalcularTodo()"></td>
          </tr>
          <tr class="summary-row">
            <td>Saldo operativo disponible</td>
            <td class="right" id="saldoOperativo">$0,00</td>
          </tr>
        </tbody>
      </table>

      <br>

      <!-- Alertas -->
      <table>
        <thead>
          <tr>
            <th>Alertas</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Fijo &gt; Ingreso</td>
            <td id="alertFijoIngreso" class="alert-ok">OK</td>
          </tr>
          <tr>
            <td>Resto disponible negativo</td>
            <td id="alertRestoNeg" class="alert-ok">OK</td>
          </tr>
          <tr>
            <td>Saldo operativo negativo</td>
            <td id="alertSaldoOperativo" class="alert-ok">OK</td>
          </tr>
          <tr>
            <td>Neto REAL negativo</td>
            <td id="alertNetoReal" class="alert-ok">OK</td>
          </tr>
        </tbody>
      </table>

      <!-- Campo oculto para compatibilidad con la subdistribuci√≥n -->
      <input type="number" id="netoRealDia" value="0" style="display:none">

      <br>

      <!-- Subdistribuci√≥n del Neto REAL -->
      <div class="card-title" style="border:none; padding-bottom:0;">Subdistribuci√≥n del Neto REAL</div>

      <table>
        <tbody>
          <tr>
            <td>Deuda flotante (%)</td>
            <td class="right" id="lblPctDeuda">70%</td>
          </tr>
          <tr>
            <td>Reserva emergencia (%)</td>
            <td class="right" id="lblPctReserva">20%</td>
          </tr>
          <tr>
            <td>Retribuci√≥n del due√±o ($ fijo)</td>
            <td class="right" id="lblRetribucion">$0,00</td>
          </tr>
        </tbody>
      </table>

      <br>

      <table>
        <tbody>
          <tr>
            <td>‚Üí Monto a Deuda</td>
            <td class="right" id="montoDeuda">$0,00</td>
          </tr>
          <tr>
            <td>‚Üí Monto a Reserva</td>
            <td class="right" id="montoReserva">$0,00</td>
          </tr>
          <tr>
            <td>‚Üí Retribuci√≥n due√±o</td>
            <td class="right" id="montoDuenio">$0,00</td>
          </tr>
          <tr class="summary-row">
            <td>‚Üí Fondo Libre</td>
            <td class="right" id="montoLibre">$0,00</td>
          </tr>
        </tbody>
      </table>

      <div class="note">
        Fondo Libre = Neto REAL - Deuda - Reserva - Retribuci√≥n del due√±o.
      </div>
    </div>
  </div>

  <!-- HISTORIAL / EVOLUCI√ìN -->
  <div class="card" style="margin-top:10px;">
    <div class="card-title">Historial de evoluci√≥n (cuadro de informaci√≥n)</div>
    <div id="historial-table">
      <table>
        <thead>
          <tr>
            <th>Fecha/Hora</th>
            <th class="right">Ingreso</th>
            <th class="right">Neto REAL</th>
            <th class="right">Deuda</th>
            <th class="right">Reserva</th>
            <th class="right">Due√±o</th>
            <th class="right">Fondo Libre</th>
            <th class="right">Total fijos</th>
            <th class="right">Fijo diario</th>
          </tr>
        </thead>
        <tbody id="historialBody">
          <!-- filas din√°micas -->
        </tbody>
      </table>
    </div>
    <div class="note">
      Cada vez que presion√°s ‚ÄúGuardar d√≠a en historial‚Äù se agrega una fila con el estado actual de la distribuci√≥n.
    </div>
  </div>

  <script>
    // ---------- UTILIDADES ----------
    function formatMoney(value) {
      return value.toLocaleString('es-AR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function getNumber(id) {
      const el = document.getElementById(id);
      if (!el) return 0;
      const v = parseFloat(el.value.replace(',', '.'));
      return isNaN(v) ? 0 : v;
    }

    function setAlerta(id, condicion) {
      const td = document.getElementById(id);
      if (!td) return;
      td.textContent = condicion ? 'ALERTA' : 'OK';
      td.className = condicion ? 'alert-bad' : 'alert-ok';
    }

    // ---------- FIJOS ----------
    function agregarFilaFijo(item = '', monto = 0) {
      const tbody = document.querySelector('#tablaFijos tbody');
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td><input type="text" value="${item}"></td>
        <td><input type="number" step="0.01" value="${monto}" oninput="recalcularTodo()"></td>
        <td class="right">
          <button class="btn danger" onclick="eliminarFila(this)">X</button>
        </td>
      `;
      tbody.appendChild(tr);
      recalcularTodo();
    }

    function eliminarFila(btn) {
      const tr = btn.closest('tr');
      tr.remove();
      recalcularTodo();
    }

    function calcularFijos() {
      const filas = document.querySelectorAll('#tablaFijos tbody tr');
      let total = 0;
      filas.forEach(tr => {
        const inputMonto = tr.querySelector('td:nth-child(2) input');
        const v = parseFloat(inputMonto.value.replace(',', '.'));
        if (!isNaN(v)) total += v;
      });
      const dias = getNumber('diasProrrateo') || 1;
      const fijoDiario = total / dias;

      document.getElementById('totalFijos').textContent = '$' + formatMoney(total);
      document.getElementById('fijoDiario').textContent = '$' + formatMoney(fijoDiario);

      return { total, fijoDiario };
    }

    // ---------- MODELO 70/30 ----------
    function calcular7030(fijoDiarioVal) {
      const ingreso = getNumber('ingresoDiario');

      document.getElementById('fijoDiario7030').textContent = '$' + formatMoney(fijoDiarioVal);

      const resto = ingreso - fijoDiarioVal;
      const pctCaja = getNumber('pctCajaOperativa');
      const pctNeto = getNumber('pctSaldoNeto');

      const operativo = resto * pctCaja / 100;
      const netoReal = resto * pctNeto / 100;

      document.getElementById('restoDisponible').textContent = '$' + formatMoney(resto);
      document.getElementById('montoOperativo').textContent = '$' + formatMoney(operativo);
      document.getElementById('montoNetoReal').textContent = '$' + formatMoney(netoReal);

      // guardar Neto REAL en campo oculto
      document.getElementById('netoRealDia').value = netoReal.toFixed(2);

      // uso del operativo
      const opVar = getNumber('opVariable');
      const opPagos = getNumber('opPagos');
      const saldoOp = operativo - opVar - opPagos;
      const saldoCell = document.getElementById('saldoOperativo');
      saldoCell.textContent = '$' + formatMoney(saldoOp);
      saldoCell.style.backgroundColor = saldoOp < 0 ? '#f8d7da' : '#d4edda';

      // alertas
      setAlerta('alertFijoIngreso', ingreso < fijoDiarioVal);
      setAlerta('alertRestoNeg', resto < 0);
      setAlerta('alertSaldoOperativo', saldoOp < 0);
      setAlerta('alertNetoReal', netoReal < 0);

      // subdistribuci√≥n del Neto REAL
      calcularSubdistribucion(netoReal);

      return { ingreso, netoReal };
    }

    // ---------- SUBDISTRIBUCI√ìN NETO REAL ----------
    function calcularSubdistribucion(netoOverride) {
      const neto = typeof netoOverride === 'number'
        ? netoOverride
        : getNumber('netoRealDia');

      const pctDeuda = getNumber('pctNetoDeuda');
      const pctReserva = getNumber('pctNetoReserva');
      const fijoDuenio = getNumber('retribucionDuenio');

      const montoDeuda = neto * pctDeuda / 100;
      const montoReserva = neto * pctReserva / 100;
      const montoDuenio = fijoDuenio;
      const montoLibre = neto - montoDeuda - montoReserva - montoDuenio;

      document.getElementById('lblPctDeuda').textContent = pctDeuda.toFixed(0) + '%';
      document.getElementById('lblPctReserva').textContent = pctReserva.toFixed(0) + '%';
      document.getElementById('lblRetribucion').textContent = '$' + formatMoney(montoDuenio);

      document.getElementById('montoDeuda').textContent = '$' + formatMoney(montoDeuda);
      document.getElementById('montoReserva').textContent = '$' + formatMoney(montoReserva);
      document.getElementById('montoDuenio').textContent = '$' + formatMoney(montoDuenio);
      document.getElementById('montoLibre').textContent = '$' + formatMoney(montoLibre);

      return {
        neto,
        deuda: montoDeuda,
        reserva: montoReserva,
        duenio: montoDuenio,
        libre: montoLibre
      };
    }

    // ---------- HISTORIAL ----------
    const historial = [];

    function agregarAlHistorial() {
      const fijos = calcularFijos();
      const modelo = calcular7030(fijos.fijoDiario);
      const sub = calcularSubdistribucion(modelo.netoReal);

      const registro = {
        fecha: new Date().toLocaleString('es-AR'),
        ingreso: modelo.ingreso,
        neto: sub.neto,
        deuda: sub.deuda,
        reserva: sub.reserva,
        duenio: sub.duenio,
        libre: sub.libre,
        totalFijos: fijos.total,
        fijoDiario: fijos.fijoDiario
      };
      historial.push(registro);
      renderHistorial();
    }

    function renderHistorial() {
      const tbody = document.getElementById('historialBody');
      tbody.innerHTML = '';
      historial.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.fecha}</td>
          <td class="right">$${formatMoney(r.ingreso)}</td>
          <td class="right">$${formatMoney(r.neto)}</td>
          <td class="right">$${formatMoney(r.deuda)}</td>
          <td class="right">$${formatMoney(r.reserva)}</td>
          <td class="right">$${formatMoney(r.duenio)}</td>
          <td class="right">$${formatMoney(r.libre)}</td>
          <td class="right">$${formatMoney(r.totalFijos)}</td>
          <td class="right">$${formatMoney(r.fijoDiario)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ---------- BACKUP JSON ----------
    function exportarJSON() {
      const fijos = [];
      document.querySelectorAll('#tablaFijos tbody tr').forEach(tr => {
        const item = tr.querySelector('td:nth-child(1) input').value;
        const monto = parseFloat(tr.querySelector('td:nth-child(2) input').value.replace(',', '.')) || 0;
        fijos.push({ item, monto });
      });

      const data = {
        parametros: {
          pctCajaOperativa: getNumber('pctCajaOperativa'),
          pctSaldoNeto: getNumber('pctSaldoNeto'),
          pctNetoDeuda: getNumber('pctNetoDeuda'),
          pctNetoReserva: getNumber('pctNetoReserva'),
          retribucionDuenio: getNumber('retribucionDuenio'),
          diasProrrateo: getNumber('diasProrrateo'),
          ingresoDiario: getNumber('ingresoDiario'),
          opVariable: getNumber('opVariable'),
          opPagos: getNumber('opPagos'),
          netoRealDia: getNumber('netoRealDia')
        },
        fijos,
        historial
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const fecha = new Date().toISOString().slice(0,10);
      a.href = url;
      a.download = `backup_parametros_caja_${fecha}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importarJSON(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);

          if (data.parametros) {
            document.getElementById('pctCajaOperativa').value = data.parametros.pctCajaOperativa ?? 70;
            document.getElementById('pctSaldoNeto').value = data.parametros.pctSaldoNeto ?? 30;
            document.getElementById('pctNetoDeuda').value = data.parametros.pctNetoDeuda ?? 70;
            document.getElementById('pctNetoReserva').value = data.parametros.pctNetoReserva ?? 20;
            document.getElementById('retribucionDuenio').value = data.parametros.retribucionDuenio ?? 0;
            document.getElementById('diasProrrateo').value = data.parametros.diasProrrateo ?? 30;
            document.getElementById('ingresoDiario').value = data.parametros.ingresoDiario ?? 0;
            document.getElementById('opVariable').value = data.parametros.opVariable ?? 0;
            document.getElementById('opPagos').value = data.parametros.opPagos ?? 0;
            document.getElementById('netoRealDia').value = data.parametros.netoRealDia ?? 0;
          }

          const tbody = document.querySelector('#tablaFijos tbody');
          tbody.innerHTML = '';
          if (Array.isArray(data.fijos)) {
            data.fijos.forEach(f => agregarFilaFijo(f.item, f.monto));
          } else {
            agregarFilaFijo('', 0);
          }

          if (Array.isArray(data.historial)) {
            historial.length = 0;
            data.historial.forEach(h => historial.push(h));
            renderHistorial();
          }

          recalcularTodo();
        } catch (err) {
          alert('Error al leer el JSON: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    // ---------- REC√ÅLCULO GLOBAL ----------
    function recalcularTodo() {
      const fijos = calcularFijos();
      calcular7030(fijos.fijoDiario);
    }

    // ---------- INICIALIZACI√ìN ----------
    window.onload = function() {
      agregarFilaFijo('Alquiler', 0);
      agregarFilaFijo('Hosting', 0);
      agregarFilaFijo('Contador', 0);
      recalcularTodo();
    };
  </script>
</body>
</html>
